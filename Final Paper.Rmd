---
title: "Final Paper"
author: "Rob St. Louis and Sasen Cain, for the Pediatric Imaging, Neurocognition and Genetics Study*"
output: pdf_document
bibliography: bibliography.bib
toc: true
---

*Data used in preparation of this article were obtained from the Pediatric Imaging, Neurocognition and Genetics Study (PING) database (http://ping.chd.ucsd.edu). As such, the investigators within PING contributed to the design and implementation of PING and/or provided data but did not participate in analysis or writing of this report. A complete listing of PING investigators can be found at https://ping-dataportal.ucsd.edu/sharing/Authors10222012.pdf.


```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
library(xtable)
library(ggplot2)
library(dplyr)
library(magrittr)

GeneticData <-read.csv("Data/DRD2andCOMTAlleles.csv",stringsAsFactors=FALSE)
BehaveData <- read.csv("Data/PING_Behavior.csv",stringsAsFactors=FALSE)
COMTData <-read.csv("Data/COMT_RS4680.csv",stringsAsFactors=FALSE)

Data <- BehaveData
#Reordering household income
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==1,5000,NA)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==2,7500,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==3,15000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==4,25000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==5,35000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==6,45000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==7,75000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==8,125000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==9,175000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==10,225000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==11,275000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_Income2 <-ifelse(Data$FDH_3_Household_Income==12,300000,Data$FDH_3_Household_Income2)
Data$FDH_3_Household_IncomeLog <-as.numeric(log10(Data$FDH_3_Household_Income2))
BehaveData <- Data

## OK, PHX_Alcohol_LifeUse_1==1 includes healthy drinking habits in college and parental guidance on how to drink wine with dinner. 
## who gets drunk? let's use that as the substance abuse DV
first_drunk = sapply(BehaveData$PHX_Alcohol_LifeAbuse_2, as.integer)
first_drunk.tab = table(first_drunk)
sum(first_drunk.tab) - first_drunk.tab["0"] ## OK, 69 kids got drunk
## just make sure they started getting drunk AFTER they started drinking!
init_drink = sapply(BehaveData$PHX_Alcohol_Initiation_1, as.integer)
table(init_drink, first_drunk)
confused_drinkers = subset(BehaveData, (first_drunk != 0) & (init_drink != 99) & (init_drink > first_drunk))  # you started drinking at age 20 and first got drunk at age 14??? REJECTED
confusedID = confused_drinkers$SubjID


BehaveData %<>% 
  mutate(got_drunk =ifelse(PHX_Alcohol_LifeAbuse_2=="",0,
                           ifelse(substr(PHX_Alcohol_LifeAbuse_2,1,1)==0,0,1)))
## verify that nobody got put somewhere strange
table(BehaveData$got_drunk,BehaveData$PHX_Alcohol_LifeAbuse_2)

Druggies <- BehaveData %>%
  filter(  got_drunk == 1             # we created            
         | PHX_Tobacco_Status_1==1
         | PHX_Substance_LifeUse_5==1  # marijuana
         | PHX_Substance_Coc_1==1    # crack or cocaine
         | PHX_Substance_Stims_1==1
         | PHX_Substance_Meth_1==1
         | PHX_Substance_Sedtv_1==1
         | PHX_Substance_Tranq_1==1
         | PHX_Substance_Painkiller_1==1
         | PHX_Substance_Halluc_1==1
         | PHX_Substance_Inhalnt_1==1
         | PHX_Substance_Heroin_1==1
) %>%
  filter(Age_At_PhenX_Completion > 14 | Age > 14, # age protocol violation
         SubjID != confusedID) ## that one confused drunk

Naives <- BehaveData %>%
  filter( got_drunk == 0, 
           PHX_Tobacco_Status_1==2,
           PHX_Substance_LifeUse_5==2,  # marijuana
           PHX_Substance_Coc_1==2,    # crack or cocaine
           PHX_Substance_Stims_1==2,
           PHX_Substance_Meth_1==2,
           PHX_Substance_Sedtv_1==2,
           PHX_Substance_Tranq_1==2,
           PHX_Substance_Painkiller_1==2,
           PHX_Substance_Halluc_1==2,
           PHX_Substance_Inhalnt_1==2,
           PHX_Substance_Heroin_1==2  ) %>%
  filter(Age_At_PhenX_Completion > 14 | Age > 14, # age protocol violation
         SubjID != confusedID) ## that one confused drunk

## this is just a quick check
## how many people said "Don't know / Decline to state" on any question?
Dunnos <- BehaveData %>%
  filter( PHX_Tobacco_Status_1==99  ## don't know/won't state
          | PHX_Substance_LifeUse_5==99)  # marijuana don't 
dim(Dunnos)[1]  ## 8 people, OK, whatever
          
DruggieID <- Druggies %>%
  select(  SubjID, 
           Alcohol = got_drunk,
           Tobacco = PHX_Tobacco_Status_1,
           Marijuana = PHX_Substance_LifeUse_5,  # marijuana
           Coca = PHX_Substance_Coc_1,
           Stims = PHX_Substance_Stims_1,
           Meth = PHX_Substance_Meth_1,
           Sedtv = PHX_Substance_Sedtv_1,
           Tranq = PHX_Substance_Tranq_1,
           Paink = PHX_Substance_Painkiller_1,
           Halluc = PHX_Substance_Halluc_1,
           Inhal = PHX_Substance_Inhalnt_1,
           Heroin = PHX_Substance_Heroin_1  )

NaiveID <- Naives %>%
  select(  SubjID, 
           Alcohol = got_drunk,
           Tobacco = PHX_Tobacco_Status_1,
           Marijuana = PHX_Substance_LifeUse_5,  # marijuana
           Coca = PHX_Substance_Coc_1,
           Stims = PHX_Substance_Stims_1,
           Meth = PHX_Substance_Meth_1,
           Sedtv = PHX_Substance_Sedtv_1,
           Tranq = PHX_Substance_Tranq_1,
           Paink = PHX_Substance_Painkiller_1,
           Halluc = PHX_Substance_Halluc_1,
           Inhal = PHX_Substance_Inhalnt_1,
           Heroin = PHX_Substance_Heroin_1  )


intersect(Druggies,Naives)$SubjID  # should be zero
intersect(Druggies,Dunnos)$SubjID  # 4 people
intersect(Naives,Dunnos)$SubjID  # 0 people ... 
## that means 4 Dunnos were otherwise naive, and said 99 on Tobacco/MJ

# table(DruggieID$Tobacco,DruggieID$Alcohol) # 14 have smoked but never drink
smokers = subset(DruggieID, Tobacco == 1)
smokers = select(smokers, -Tobacco)
filter(smokers, Alcohol==0,
       Marijuana==2 | Marijuana==99,
       Coca==2, Stims==2, Meth==2,Sedtv==2,Tranq==2,Paink==2,
       Halluc==2, Inhal==2,Heroin==2)$SubjID  ### this is just 6 people



########### HERE ARE THE QUESTIONS
#----PHX_Alcohol_LifeAbuse_2,  --> became got_drunk (1=Ever, 0 =Never)
#"How old were you the first time you got drunk, that is, your speech was slurred or you were unsteady on your feet?"
#----PHX_Tobacco_Status_1,
#"Have you ever smoked part or all of a cigarette? (1=Yes, 2=No, 99=Don't Know/Decline to state)"
#----PHX_Substance_LifeUse_5,
#"In your entire life, have you EVER tried marijuana (pot, weed, hash, bud, doobie, reefer, mary-jane, puff)? (1=Yes, 2=No, 99=Don't know/Decline to State)
#----PHX_Substance_Coc_1,
#"Have you EVER used cocaine or crack? (1=Yes, 2=No)"
#----PHX_Substance_Stims_1,
#"Have you EVER used stimulants, for example, Preludin, Benzedrine, Methedrine, Ritalin, uppers, or speed? (1=Yes, 2=No)"
#----PHX_Substance_Meth_1,
#"Have you EVER used meth-amphetamines (crystal meth, ice, batu, crank, tine, tweak, glass, junk)? (1=Yes, 2=No)"
#----PHX_Substance_Sedtv_1,
#"Have you EVER used sedatives, for example, sleeping pills, barbiturates, Seconal, Quaaludes, or Chloral Hydrate? (1=Yes, 2=No)"
#----PHX_Substance_Tranq_1,
#"Have you EVER used tranquilizers or anti-anxiety drugs, for example, Valium, Librium, muscle relaxants, or Zanax (1=Yes, 2=No)"
#----PHX_Substance_Painkiller_1,
#"Have you EVER used painkillers, for example, Codeine, Darvon, Percodan, OxyContin, Dilaudid, Demerol, Celebrex, or Vioxx? (1=Yes, 2=No)"
#----PHX_Substance_Halluc_1,
#"Have you EVER used hallucinogens, for example, Ecstasy/MDMA, GHB, Ketamine, LSD, mescaline, psilocybin, PCP, angel dust, or peyote? (1=Yes, 2=No)
#----PHX_Substance_Inhalnt_1,
#"Have you EVER used inhalants or solvents, for example, amyl nitrite, nitrous oxide, glue, toluene or gasoline? (1=Yes, 2=No)
#----PHX_Substance_Heroin_1,
#"Have you EVER used heroin? (1=Yes, 2=No)"


#create the final dataset


Druggies$UseSubstance <-1
Naives$UseSubstance <-0




Data2 <- data.frame(rbind(Druggies,Naives))%>%
  left_join(GeneticData,by=c("SubjID")) %>%
  left_join(COMTData,by=c("SubjID")) 

Data <-Data2 %>%
  select(GAF_africa,GAF_eastAsia,GAF_oceania,GAF_centralAsia,GAF_europe,GAF_amerind, FDH_3_Household_Income2,FDH_3_Household_IncomeLog,Gender,
         rs4680,rs12364283,rs1800497,
         PHX_PSS_TOTAL,
         PHX_IMP_TOTAL,
         Age_At_PhenX_Completion,
         UseSubstance
         )%>%
  na.omit()

table(Data$UseSubstance)



  
  



```

#Introduction
The high apparent hereditability of substance abuse disorders [XXXX]has long suggested that vulnerability may be genetic. There have now been broad studies comparing adult substance abusers to healthy controls in the hopes of identifying the genetic components of one’s risk. By identifying the specific genes that predict those who are affected by substance abuse disorders, we might be able to identify the mechanism underying various components of individuals' susceptibility to the drug in question. 

However, what is distinct about substance abuse is that one must first use a psychoactive substance to become addicted to that substance. Those who struggle with substance abuse appear to have lower discount rates (cite), and they are more risk seeking(cite) than the general population. Part of the genetic risk factors that may influence one’s likelihood of acquiring a debilitating dependence on a psychoactive substance may be those that influence the likelihood of trying or using the drug, despite the apparent adverse consequences.


However, the risky and behavior and possible poor judgement of those who try dangerous substances clearly does not exist in a vacuum. Our social and economic environment will influence both the availability of psychoactive substances, the messages we learn about the substances, and the magnitude of the consequences for using those substances. In adults there is a robust association between SES status and substance abuse (cite). However, there is signifcant debate about whether this is true for adolescents [@hanson2007socioeconomic,@goodman2002socioeconomic]. This suggest that, SES might not play a major role in likelihood of using a substance. Another possibility, however, is that SES might only have a protective influence for those who are particularly vulnerable. 

In this study we use a cognitive model proposed by @frank2007genetic that would let us identify the risk factors that might make it more likely that we could identify the underlying mechanism in this modelk

##Role of Prefrontal Dopamine Density

@frank2007genetic found a genetic triple dissocaition between SNPs that regulated different components of the dopaminergic system. One component appeared to regulate prefronal, apparently model-based, control over decision making behavior in a reinforcement learning task. This was a functional single nucleotide polymorphism (SNP) involved in the COMT gene. Those with the MET allele have higher prefronal dopamine levels and greater top down control over learning.  A later paper by the same group of researchers [@doll2011dopaminergic] found that this same allele predicted the degree to which participants were likely to be influenced by explicit statements. Together this suggests that those with the MET allele, compared to those with the VAL allele that is associated with lower prefrontal dopamine function, might be more likely to internalize the explicit messages they receive about the dangers of using substances. Other researcher have started to look at whether variation in COMT function predicts susceptibiltiy to addition  [@m2012role], but the question of whether or not it predicts a greater likelihood of adolecents and younger adults trying drugs has not been studied.

##Role of Striatal D2 receptor density

Another related SNP studied by these researchers was the C957T polymorphism of the DRD2 gene, that influenced participants ability to learn from negative reinforcement [@frank2007genetic]. DRD2 seems to have a selective effect on striatal, postsynaptic DA receptor density, and is implicated in learning from phasic dips in striatal dopamine. While the specific SNP used in that study, the C957T polymorphism is not available through PING, another SNP identified by @frank2009genetic, (rs12364283) influenced the same gene and appeared to have the same selective effecton on inhibitory learning. We hypothesized that those who are more likely to be able ot avoid negative outcomes may be more likely avoid use of dangergous psychoatctive substances.


#Methods

Data used in the preparation of this article were obtained from the Pediatric Imaging, Neurocognition and Genetics (PING) Study database (http://ping.chd.ucsd.edu/). PING was launched in 2009 by the National Institute on Drug Abuse (NIDA) and the Eunice Kennedy Shriver National Institute Of Child Health & Human Development (NICHD) as a 2-year project of the American Recovery and Reinvestment Act. The primary goal of PING has been to create a data resource of highly standardized and carefully curated magnetic resonance imaging (MRI) data, comprehensive genotyping data, and developmental and neuropsychological assessments for a large cohort of developing children aged 3 to 20 years. The scientific aim of the project is, by openly sharing these data, to amplify the power and productivity of investigations of healthy and disordered development in children, and to increase understanding of the origins of variation in neurobehavioral phenotypes. For up-to-date information, see http://ping.chd.ucsd.edu/.

#Participants

Participants were recruited throuh PING, a nine site, cross-sectional study of roughly 1,400 children and adolencents from 3-20 years of age. Participants provided a saliva sample for whole genome sequencing, underwent three hours of neurocognitive testing and completed a one hour MRI session. Participants were subject to modest screening and those with a significant neurological disorder, or whose mother used alcohol or an illegal substance daily during pregnancy were screened.  Six of the nine sites participated in the additional testing, where children 14 and older were sent a web based interview based on PhenX questionniares that included questions about their tobacco, alcohol and illegal substance use. We do not have access to the geographcial location of the participants. PhenX is a site of validated measures, sponsored by NIH, designed to facilite cross-study comparisons(Hamilton et. al 2006)

###Single Nucleotide Polymorphisms
Participants DNA was collected with a mouth swab and a whole genotype sequencing was performed using the Illumina Human660W-Quad BeadChip. Included in the 494,082 SNPs passing the PING quality control filters were the Val158Met polymorphism that influences the COMT gene (rs4680), and an SNP influence post-synaptic D2 density in the striatum (Frank & Hutchingson, 2011). 

### Family Income
Parents of participants were asked to indicate their family's total income in the past year.This was reported in a 12 point scale, with categories ranging from "<$5,000" to ">$300,000". To turn this data into a numeric veriable, we took the mean value for each category (i.e. "$20,000 to 29,999" was coded as 35,000). The endpoints were coded as the least extreme value(i.e. "20,000"), so that this coding scheme is a conservative estiamte of income variance. 


```{r,echo=FALSE}
# IncomeHist <- data.frame(t(table(Data$FDH_3_Household_Income2)))
# 
# qplot(data=IncomeHist, Freq,Var2,size=40) + ylab("Total Annual Family Income ($)")+xlab("Frequency")

```


##Significant Substance Abuse. 
Participants 14 and older at were provided with an online verions of the PhenX ... drug history questionnaire. This asked about their use of **SASEN Answer**




###Possible Confounders

We tested whether age and gender influenced the likelihood of having used a psychoactive substance. There was an importantrelationship between the age and likelihood of using a substance, as you can see in Figure 1.


```{r,echo=FALSE,fig.cap="Figure 1",fig.subcap="Error bars indicated 95% bionomial C.I."}

Data$AgeRound <- floor(Data$Age_At_PhenX_Completion)

PlotD <- Data %>%
  group_by(AgeRound)%>%
  summarize(x =as.numeric(sum(UseSubstance==1)),
            n =as.numeric(length(UseSubstance==1)))



binomest <-function(x,n){
  y= binom.test(x,n)
  return(list(y$estimate[1],y$conf.int[1],y$conf.int[2]))
}


PlotD$p <- 0
PlotD$plow <- 0
PlotD$phigh <- 1
for(i in 1:9){
  x= as.numeric(PlotD[i,"x"])
  n= as.numeric(PlotD[i,"n"])
  PlotD[i,"p"] <- binomest(x,n)[1]
  PlotD[i,"plow"] <- binomest(x,n)[2]
  PlotD[i,"phigh"] <- binomest(x,n)[3]
}


qplot(AgeRound,p,data=PlotD) + geom_errorbar(aes(ymin=plow,ymax=phigh,width=0)) +ylab("Probability of Using Substance")+xlab("Age") +ggtitle("Effect of Age on the Probability of Using a Substance")
```

```{r,echo=FALSE,results='hide'}
m0 <- glm(UseSubstance~Age_At_PhenX_Completion*Gender,family='binomial',data=Data)
#m1 <- glm(UseSubstance~sqrt(Age_At_PhenX_Completion),family='binomial',data=Data)
# 
# 
xtable(anova(m0,test="Chisq"))
```

t
```{r}


```

##Full model

As stated, we wanted to test whether these genetic variants appeared to have any effect on likelihood of using a substance. Unfortunately, given our limited power, we did not find the 

```{r}




m0 <- glm(UseSubstance~GAF_africa+GAF_eastAsia+GAF_oceania+GAF_centralAsia+GAF_europe +Gender+log(Age_At_PhenX_Completion),family='binomial',data=Data)

m1 <- glm(UseSubstance~Age_At_PhenX_Completion+rs4680+rs12364283 +rs4680*FDH_3_Household_IncomeLog+ rs12364283*FDH_3_Household_IncomeLog,
            family='binomial',data=Data)

# Data$COMT <-ifelse(Data$rs4680=="AA",2,NA)
# Data$COMT <-ifelse(Data$rs4680=="AG",1,Data$COMT)
# Data$COMT <-ifelse(Data$rs4680=="GG",0,Data$COMT)

# m2 <- glm(COMT~Gender+log(Age_At_PhenX_Completion)+rs4680+rs12364283 +FDH_3_Household_IncomeLog,
#             family='binomial',data=Data)

summary(m1)

anova(m1,test="Chisq")

qplot(FDH_3_Household_IncomeLog,jitter(UseSubstance),geom=c("point","smooth"),method="lm",data=Data,facets=.~rs12364283)


# Data %>%
#   group

```


Creating the genetic markers. Borrowing from Frank et al (2006), we set the Val158Met polymorphism. in the 

Ok, plan: describe

SES factors:
```{r}

plotIncomeCOMT <-Data %>%
  filter(is.na(rs4680)==F,
         is.na(FDH_3_Household_IncomeLog)==F)%>%
  group_by(FDH_3_Household_IncomeLog)%>%
  dplyr::summarize(propCOMTMET=mean(rs4680=="AA"),
                   propCOMTVAL=mean(rs4680=="GG"),
                   propCOMTVALMET =mean(rs4680=="AG"))

qplot(data=plotIncomeCOMT, FDH_3_Household_IncomeLog,propCOMTVAL,geom="line",color="Val") +geom_line(data=plotIncomeCOMT, aes(FDH_3_Household_IncomeLog,propCOMTMET,color="MET"))+geom_line(data=plotIncomeCOMT, aes(FDH_3_Household_IncomeLog,propCOMTVALMET,color="VAL/MET")) 



```











```


You can also embed plots, for example:

```{r, echo=FALSE}
qplot(Data$rs12364283)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

#Acknowledgements

Data collection and sharing for this project was funded by the Pediatric Imaging, Neurocognition and Genetics Study (PING) (National Institutes of Health Grant RC2DA029475). PING is funded by the National Institute on Drug Abuse and the Eunice Kennedy Shriver National Institute of Child Health & Human Development. PING data are disseminated by the PING Coordinating Center at the Center for Human Development, University of California, San Diego.

#Bibliography

Akshoomoff, N., Newman, E., Thompson, W. K., McCabe, C., Bloss, C. S., Chang, L., ... & Jernigan, T. L. (2014). The NIH Toolbox Cognition Battery: Results from a large normative developmental sample (PING). Neuropsychology, 28(1), 1.

Hamilton CM, Strader LC, Pratt JG, Maiese D, Hendershot T, Kwok RK,Hammond JA, Huggins W, Jackman D, Pan H, Nettles DS, Beaty TH, Farrer LA, Kraft P, Marazita ML, Ordovas JM, Pato CN, Spitz MR, Wagener D,Williams M, Junkins HA, Harlan WR, Ramos EM, Haines J: The PhenX toolkit:get the most from your measures. Am J Epidemiol 2011, 174:253–260
[@frank2009genetic]

#References

